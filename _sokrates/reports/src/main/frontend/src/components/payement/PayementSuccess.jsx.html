<html>
<head>
    <title>frontend/src/components/payement/PayementSuccess.jsx</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">frontend/src/components/payement/PayementSuccess.jsx (<b>194</b> lines of code) (<a href="PayementSuccess.jsx">raw</a>):</h3>
<div id="editor">import { useState, useEffect, useContext } from &quot;react&quot;;
import { useNavigate, useSearchParams } from &quot;react-router-dom&quot;;
import { supabase } from &quot;../../supabaseClient&quot;;
import { AuthContext } from &quot;../../context/auth-context&quot;;
import { API_BASE_URL } from &quot;../../config/api&quot;;
import &quot;./PayementSuccess.css&quot;;

function ActionButtons({ navigate }) {
  return (
    &lt;div className=&quot;action-buttons&quot;&gt;
      &lt;button onClick={() =&gt; navigate(&quot;/login&quot;)} className=&quot;primary-button&quot;&gt;
        Go to Login
      &lt;/button&gt;
      &lt;button onClick={() =&gt; navigate(&quot;/&quot;)} className=&quot;secondary-button&quot;&gt;
        Return to Home
      &lt;/button&gt;
    &lt;/div&gt;
  );
}

function StatusCard({ type = &quot;success&quot;, title, children }) {
  const cardClass = type === &quot;error&quot; ? &quot;error-card&quot; : &quot;success-card&quot;;
  return (
    &lt;div className={cardClass}&gt;
      {type === &quot;success&quot; &amp;&amp; title &amp;&amp; &lt;h3&gt;{title}&lt;/h3&gt;}
      {type === &quot;error&quot; &amp;&amp; title &amp;&amp; (
        &lt;h3 style={{ color: &quot;#00c3ffff&quot; }}&gt;{title}&lt;/h3&gt;
      )}
      {children}
    &lt;/div&gt;
  );
}

export default function PaymentSuccess() {
  const [searchParams] = useSearchParams();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(&quot;&quot;);
  const [emailSent, setEmailSent] = useState(false);
  const navigate = useNavigate();
  const auth = useContext(AuthContext);

  useEffect(() =&gt; {
    const verifyPayment = async () =&gt; {
      try {
        const sessionId = searchParams.get(&quot;session_id&quot;);
        if (!sessionId) {
          setError(&quot;No payment session found&quot;);
          setLoading(false);
          return;
        }

        const response = await fetch(`${API_BASE_URL}/api/verify-payment`, {
          method: &quot;POST&quot;,
          headers: { &quot;Content-Type&quot;: &quot;application/json&quot; },
          body: JSON.stringify({ sessionId }),
        });
        if (!response.ok) throw new Error(&quot;Payment verification failed&quot;);

        const result = await response.json();
        if (result.success) {
          const signupData = JSON.parse(
            sessionStorage.getItem(&quot;signupData&quot;) || &quot;{}&quot;
          );
          const { data, error: signupError } = await supabase.auth.signUp({
            email: result.customerEmail,
            password: signupData.password,
            options: {
              data: {
                first_name: signupData.firstName,
                last_name: signupData.lastName,
                full_name: `${signupData.firstName} ${signupData.lastName}`,
                stripe_customer_id: result.customerId,
                payment_status: &quot;completed&quot;,
                subscription_status: &quot;active&quot;,
                amount_paid: result.amountPaid,
                currency: result.currency,
              },
            },
          });

          if (signupError) {
            console.error(&quot;Signup error:&quot;, signupError);
            if (
              signupError.message.includes(&quot;already been registered&quot;) ||
              signupError.message.includes(&quot;Database error saving new user&quot;) ||
              signupError.message.includes(&quot;User already registered&quot;)
            ) {
              setError(
                &quot;Your payment was successful! Please check your email for the confirmation link, then use the login page to access your account.&quot;
              );
            } else {
              setError(
                &quot;Account creation failed. Please contact support with your payment confirmation.&quot;
              );
            }
            setLoading(false);
            return;
          }

          sessionStorage.removeItem(&quot;signupData&quot;);

          if (data.user &amp;&amp; !data.session) {
            setEmailSent(true);
          } else if (data.session) {
            auth.login(data.user.id, data.session.access_token);
            setTimeout(() =&gt; navigate(&quot;/&quot;), 3000);
          }
        } else {
          setError(&quot;Payment verification failed&quot;);
        }
      } catch (err) {
        console.error(&quot;Payment verification error:&quot;, err);
        setError(&quot;Payment verification error. Please contact support.&quot;);
      } finally {
        setLoading(false);
      }
    };
    verifyPayment();
  }, [searchParams, navigate, auth]);

  if (loading) {
    return (
      &lt;div className=&quot;payment-success-container&quot;&gt;
        &lt;StatusCard title=&quot;Verifying your payment...&quot;&gt;
          &lt;div className=&quot;spinner&quot;&gt;&lt;/div&gt;
          &lt;p&gt;Please wait while we set up your account.&lt;/p&gt;
        &lt;/StatusCard&gt;
      &lt;/div&gt;
    );
  }

  if (error) {
    return (
      &lt;div className=&quot;payment-success-container&quot;&gt;
        &lt;StatusCard type=&quot;error&quot; title=&quot;Account Setup&quot;&gt;
          &lt;p&gt;{error}&lt;/p&gt;
          &lt;ActionButtons navigate={navigate} /&gt;
        &lt;/StatusCard&gt;
      &lt;/div&gt;
    );
  }

  if (emailSent) {
    return (
      &lt;div className=&quot;payment-success-container&quot;&gt;
        &lt;StatusCard title=&quot;Payment Successful!&quot;&gt;
          &lt;div className=&quot;email-icon&quot;&gt;ðŸ“§&lt;/div&gt;
          &lt;p&gt;Your payment has been processed successfully.&lt;/p&gt;

          &lt;div className=&quot;email-confirmation-info&quot;&gt;
            &lt;h4&gt;Please Check Your Email&lt;/h4&gt;
            &lt;p&gt;
              We&amp;apos;ve sent a confirmation email. Click the link to activate
              your NutriTrack account.
            &lt;/p&gt;
            &lt;div className=&quot;email-steps&quot;&gt;
              &lt;div className=&quot;step&quot;&gt;
                &lt;span className=&quot;step-number&quot;&gt;1. &lt;/span&gt;
                &lt;span className=&quot;step-text&quot;&gt;Check your inbox&lt;/span&gt;
              &lt;/div&gt;
              &lt;div className=&quot;step&quot;&gt;
                &lt;span className=&quot;step-number&quot;&gt;2. &lt;/span&gt;
                &lt;span className=&quot;step-text&quot;&gt;Click the confirmation link&lt;/span&gt;
              &lt;/div&gt;
              &lt;div className=&quot;step&quot;&gt;
                &lt;span className=&quot;step-number&quot;&gt;3. &lt;/span&gt;
                &lt;span className=&quot;step-text&quot;&gt;Return to login&lt;/span&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div className=&quot;email-note&quot;&gt;
              &lt;p&gt;
                &lt;strong&gt;Note:&lt;/strong&gt; The email may take a few minutes. Check
                your spam folder.
              &lt;/p&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          &lt;ActionButtons navigate={navigate} /&gt;
        &lt;/StatusCard&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className=&quot;payment-success-container&quot;&gt;
      &lt;StatusCard title=&quot;Welcome to NutriTrack!&quot;&gt;
        &lt;div className=&quot;success-icon&quot;&gt;âœ“&lt;/div&gt;
        &lt;p&gt;
          Your account has been created successfully and you are now logged in.
        &lt;/p&gt;
        &lt;p&gt;You will be redirected to the dashboard in a few seconds...&lt;/p&gt;

        &lt;div className=&quot;welcome-info&quot;&gt;
          &lt;h4&gt;You can now:&lt;/h4&gt;
          &lt;ul&gt;
            &lt;li&gt;Explore our complete food catalogue&lt;/li&gt;
            &lt;li&gt;Use our nutrition calculators&lt;/li&gt;
            &lt;li&gt;Start planning your meals&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;

        &lt;button
          onClick={() =&gt; navigate(&quot;/&quot;)}
          className=&quot;primary-button dashboard-button&quot;
        &gt;
          Continue to Dashboard
        &lt;/button&gt;
      &lt;/StatusCard&gt;
    &lt;/div&gt;
  );
}
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/html");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
